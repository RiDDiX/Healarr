# Healarr - Copilot Instructions

## Project Overview
Healarr (Health Evaluation And Library Auto-Recovery for *aRR) is an event-driven file corruption detection and remediation system for Sonarr/Radarr media libraries. It scans media files, detects corruption, auto-deletes bad files via *arr APIs, triggers re-downloads, and verifies replacements.

## Tech Stack
- **Backend**: Go 1.25+ with Gin framework, SQLite, custom EventBus (pub/sub + persistence)
- **Frontend**: React 19 + TypeScript + Vite 7 + Tailwind CSS v4 + TanStack Query
- **External**: Sonarr/Radarr REST APIs, ffprobe/mediainfo/HandBrake for corruption detection

## Project Structure
```
Healarr/
├── cmd/server/main.go           # Entry point - bootstraps all services
├── internal/
│   ├── api/rest.go              # REST endpoints (Gin handlers)
│   ├── api/websocket.go         # Real-time updates hub
│   ├── services/                # Core business logic (scanner, remediator, verifier, monitor, scheduler)
│   ├── integration/             # External integrations (arr_client, health_checker, path_mapper)
│   ├── eventbus/eventbus.go     # Event pub/sub with SQLite persistence
│   ├── domain/events.go         # Event type definitions
│   ├── db/migrations/           # SQL migrations (numbered 001-XXX)
│   └── logger/                  # Structured logging
├── frontend/
│   ├── src/pages/               # React page components
│   ├── src/lib/api.ts           # API client + TypeScript types
│   ├── src/components/          # Reusable UI components
│   └── src/types/api.ts         # Shared API types
└── web/                         # Built frontend - generated by `npm run build` (not in git)
```

## Critical Patterns

### Event-Driven Architecture
All state changes flow through `EventBus.Publish()`. Services subscribe to events:
```go
// Publishing (scanner.go)
s.eventBus.Publish(domain.Event{
    AggregateType: "corruption",
    AggregateID:   uuid.New().String(),
    EventType:     domain.CorruptionDetected,
    EventData:     map[string]interface{}{"file_path": path},
})

// Subscribing (remediator.go)
r.eventBus.Subscribe(domain.CorruptionDetected, r.handleCorruptionDetected)
```

### Smart Verification
After deletion, *arr often renames files on re-import. Use `ArrClient.GetFilePath(mediaID, metadata, refPath)` to query *arr for the NEW path instead of checking the old one.

### Database Migrations
- Location: `internal/db/migrations/XXX_description.sql`
- Auto-applied on server startup in order
- Current: 013, next new migration should be 014

### Frontend API Pattern
Use TanStack Query with typed API functions from `src/lib/api.ts`:
```tsx
const { data, isLoading } = useQuery({
    queryKey: ['scans'],
    queryFn: () => getScans(page, limit),
});
```

## Build Commands
```bash
# Full build (backend + frontend)
go build -o healarr cmd/server/main.go && cd frontend && npm run build && cd ..

# Run server (serves API + frontend on port 3090)
./healarr

# Frontend dev mode (hot reload, proxies to :3090)
cd frontend && npm run dev
```

## Key Implementation Details

### Port: 3090 (configurable via HEALARR_PORT)
### Database: SQLite at `./healarr.db` (configurable via HEALARR_DATABASE_PATH)
### Logs: `./logs/healarr.log` with rotation

### Adding New Endpoints
1. Add handler in `internal/api/rest.go`
2. Register route in `setupRoutes()` (protected group for auth)
3. Add TypeScript types/functions in `frontend/src/lib/api.ts`

### Adding New Events
1. Define constant in `internal/domain/events.go`
2. Publish via `eventBus.Publish(domain.Event{...})`
3. Subscribe in relevant service's `Start()` method

## Code Style
- **Go**: Use `switch` over `if/else` chains, handle all errors, use `logger.Infof()`/`logger.Errorf()`
- **TypeScript**: Use `unknown` over `any`, prefer `const`, use TanStack Query for server state
- **SQL**: Use migrations for ALL schema changes, add indexes for frequently queried columns

## Testing Workflow
1. Build: `go build -o healarr cmd/server/main.go && cd frontend && npm run build`
2. Run: `./healarr`
3. Access: http://localhost:3090
4. Check logs: `tail -f logs/healarr.log`

## Repository
GitHub: https://github.com/mescon/Healarr
